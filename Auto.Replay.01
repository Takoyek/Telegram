import logging
from sqlalchemy import create_engine, Column, Integer, String
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker
from telethon import TelegramClient, events

# ØªÙ†Ø¸ÛŒÙ…Ø§Øª logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Ø§Ø·Ù„Ø§Ø¹Ø§Øª API
api_id = 29646851
api_hash = '70a40f9db30071a7be02eb35fef561b6'
phone_number = '+989155841124'

# Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù„Ø§ÛŒÙ†Øª
client = TelegramClient('my_session', api_id, api_hash)

# Ø§ÛŒØ¬Ø§Ø¯ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ùˆ ØªÙ†Ø¸ÛŒÙ…Ø§Øª SQLAlchemy
engine = create_engine('sqlite:///my_session.db', connect_args={'check_same_thread': False})
Session = sessionmaker(bind=engine)
session = Session()
Base = declarative_base()

# ØªØ¹Ø±ÛŒÙ Ù…Ø¯Ù„ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
class UserState(Base):
    __tablename__ = 'user_state'
    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, unique=True, nullable=False)
    state = Column(String, nullable=False)

Base.metadata.create_all(engine)

# Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ ÙˆØ¶Ø¹ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
user_state = {}

# Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø«Ø§Ø¨Øª
MESSAGES = {
    "main_menu": "1ï¸âƒ£ Ø¬Ù‡Øª ØªÙ…Ø¯ÛŒØ¯ Ø§Ø´ØªØ±Ø§Ú© ÙØ¹Ù„ÛŒ Ø¹Ø¯Ø¯  1  Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.\n"
                 "2ï¸âƒ£ Ø¬Ù‡Øª Ø®Ø±ÛŒØ¯ Ø§Ø´ØªØ±Ø§Ú© Ø¬Ø¯ÛŒØ¯ Ø¹Ø¯Ø¯  2  Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.\n"
                 "3ï¸âƒ£ Ø¬Ù‡Øª Ø§Ø·Ù„Ø§Ø¹ Ø§Ø² Ù…Ø§Ù†Ø¯Ù‡ Ø§Ø´ØªØ±Ø§Ú© Ø¹Ø¯Ø¯  3  Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.\n"
                 "4ï¸âƒ£ Ø¬Ù‡Øª ØªØºÛŒÛŒØ± Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¹Ø¯Ø¯  4  Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.",
    "greeting": "Ø³Ù„Ø§Ù…!\nâ˜ºï¸ Ù…Ù† ÛŒÚ© Ù¾Ø§Ø³Ø®Ú¯ÙˆÛŒ Ø¢Ù†Ù„Ø§ÛŒÙ† Ù‡Ø³ØªÙ….",
    "name_request": "Ù„Ø·ÙØ§ Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:",
    "new_username_prompt": "Ù„Ø·ÙØ§ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:",
    "welcome_user": 'âœ¨ Ø³Ù„Ø§Ù… {username} Ø¹Ø²ÛŒØ²ØŒ Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒğŸŒ¹',
    "confirm_username": 'âœ¨ Ù†Ø§Ù…  Ø´Ù…Ø§ "{text}" Ø«Ø¨Øª Ø´Ø¯.\n\n'
                        'âœ…  Ø§Ú¯Ø± Ù†Ø§Ù… Ø´Ù…Ø§ Ù…ÙˆØ±Ø¯ ØªØ§ÛŒÛŒØ¯ Ø§Ø³Øª Ø¹Ø¯Ø¯  1  Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.\n'
                        'ğŸ”„  Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¹Ø¯Ø¯  2  Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.',
    "renew_subscription_prompt": "âœï¸ Ù†Ø§Ù… Ø§Ø´ØªØ±Ø§Ú©ÛŒ Ú©Ù‡ Ù…ÛŒ Ø®ÙˆØ§Ù‡ÛŒØ¯ ØªÙ…Ø¯ÛŒØ¯ Ø´ÙˆØ¯ Ú†ÛŒØ³ØªØŸ",
    "renew_subscription_confirmation": 'â­ï¸ Ø§Ø´ØªØ±Ø§Ú© Ø´Ù…Ø§ Ø¨Ø§ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ "{username}" Ø¯Ø± Ø§Ø³Ø±Ø¹ ÙˆÙ‚Øª ØªÙ…Ø¯ÛŒØ¯ Ø´Ø¯Ù‡ Ùˆ Ø¨Ù‡ Ø§Ø·Ù„Ø§Ø¹ Ø´Ù…Ø§ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.',
    "renew_subscription_details": ["ğŸ’° Ù‡Ø²ÛŒÙ†Ù‡ Ø§Ø´ØªØ±Ø§Ú© Ø±Ø§ ÙˆØ§Ø±ÛŒØ² Ú©Ù†ÛŒØ¯ Ø¨Ù‡ Ú©Ø§Ø±Øª:\n\n"
                                   "5859831191786085\nØ´Ú©ÙˆÙÙ‡ Ø±Ø¶Ø§ÛŒÛŒ - Ø¨Ø§Ù†Ú© ØªØ¬Ø§Ø±Øª\n\n"
                                   "ğŸ”µ - Ø§Ø±Ø³Ø§Ù„ Ø§Ø³Ú©Ø±ÛŒÙ† Ø´Ø§Øª Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª.\n"
                                   "ğŸŸ¢ - Ù…Ù‡Ù„Øª ØªØ³Øª Ùˆ Ù¾Ø±Ø¯Ø§Ø®Øª 48 Ø³Ø§Ø¹Øª Ø§Ø³Øª.\n"
                                   "ğŸŸ¡ - Ø¯Ø± ØµÙˆØ±Øª Ø¹Ø¯Ù… Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ø´ØªØ±Ø§Ú© Ø´Ù…Ø§ Ù„ØºÙˆ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.",
                                   "9ï¸âƒ£ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ø±Ø­Ù„Ù‡ Ù‚Ø¨Ù„ÛŒ Ø¹Ø¯Ø¯  9  Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.\n"
                                   "0ï¸âƒ£ Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯ Ø¹Ø¯Ø¯  0  Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯."],
    "subscription_info_prompt": "âœï¸ Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø§Ø´ØªØ±Ø§Ú© Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.",
    "subscription_info_confirmation": 'â­ï¸ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ù…Ø§ Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù„Ø§Ø¹ Ø§Ø² Ù…Ø§Ù†Ø¯Ù‡ Ø§Ø´ØªØ±Ø§Ú© "{username}" Ø¯Ø± Ø§Ø³Ø±Ø¹ ÙˆÙ‚Øª Ø¨Ø±Ø±Ø³ÛŒ Ø´Ø¯Ù‡ Ùˆ Ø¨Ù‡ Ø´Ù…Ø§ Ø§Ø·Ù„Ø§Ø¹ Ø¯Ø§Ø¯Ù‡ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.',
    "subscription_info_options": "9ï¸âƒ£ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ø±Ø­Ù„Ù‡ Ù‚Ø¨Ù„ÛŒ Ø¹Ø¯Ø¯  9  Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.\n"
                                 "0ï¸âƒ£ Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯ Ø¹Ø¯Ø¯  0  Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.",
    "new_subscription_prompt": "âœï¸ Ù„Ø·ÙØ§ ÛŒÚ© Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø´ØªØ±Ø§Ú© Ø¬Ø¯ÛŒØ¯ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:",
    "50G": "50 Ú¯ÛŒÚ¯",
    "30G": "30 Ú¯ÛŒÚ¯",
    "90T": "90 Ù‡Ø²Ø§Ø± ØªÙˆÙ…Ø§Ù†",
    "110T": "110 Ù‡Ø²Ø§Ø± ØªÙˆÙ…Ø§Ù†",
    "subscription_50_prompt": 'â­ï¸ Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø¨Ø§ Ù…Ø´Ø®ØµØ§Øª:\n\n'
                              'Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ: "{username}"\n'
                              'Ø­Ø¬Ù…: "{volume}"\n'
                              'Ø³ÛŒ Ø±ÙˆØ²Ù‡\n\n'
                              'Ø¯Ø± Ø§Ø³Ø±Ø¹ ÙˆÙ‚Øª Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ Ùˆ Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ Ø§Ø±Ø³Ø§Ù„ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.',
    "subscription_30_prompt": 'â­ï¸ Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø¨Ø§ Ù…Ø´Ø®ØµØ§Øª:\n\n'
                              'Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ: "{username}"\n'
                              'Ø­Ø¬Ù…: "{volume}"\n'
                              'Ø³ÛŒ Ø±ÙˆØ²Ù‡\n\n'
                              'Ø¯Ø± Ø§Ø³Ø±Ø¹ ÙˆÙ‚Øª Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ Ùˆ Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ Ø§Ø±Ø³Ø§Ù„ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.',

    "new_subscription": ["â­ï¸ Ø¬Ù‡Øª Ø®Ø±ÛŒØ¯ Ø§Ø´ØªØ±Ø§Ú© Ø¹Ø¯Ø¯ Ù…Ø±Ø¨ÙˆØ·Ù‡ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:\n\n"
                         "ğŸ”° Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯ 50 Ú¯ÛŒÚ¯ - 110 Ù‡Ø²Ø§Ø± ØªÙˆÙ…Ø§Ù† Ø¹Ø¯Ø¯   50   Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.\n"
                         "ğŸ”° Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯ 30 Ú¯ÛŒÚ¯ - 90 Ù‡Ø²Ø§Ø± ØªÙˆÙ…Ø§Ù† Ø¹Ø¯Ø¯   30   Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.\n",
                         "9ï¸âƒ£ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ø±Ø­Ù„Ù‡ Ù‚Ø¨Ù„ÛŒ Ø¹Ø¯Ø¯  9  Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.\n"
                         "0ï¸âƒ£ Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯ Ø¹Ø¯Ø¯  0  Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯."],

    "subscription_info": ["âœï¸ Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø§Ø´ØªØ±Ø§Ú© Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.",
                          "â­ï¸ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ù…Ø§ Ø¯Ø± Ø§Ø³Ø±Ø¹ ÙˆÙ‚Øª Ø¨Ø±Ø±Ø³ÛŒ Ø´Ø¯Ù‡ Ùˆ Ø¨Ù‡ Ø´Ù…Ø§ Ø§Ø·Ù„Ø§Ø¹ Ø¯Ø§Ø¯Ù‡ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.",
                          "9ï¸âƒ£ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ø±Ø­Ù„Ù‡ Ù‚Ø¨Ù„ÛŒ Ø¹Ø¯Ø¯  9  Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.\n"
                          "0ï¸âƒ£ Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯ Ø¹Ø¯Ø¯  0  Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯."],

    "subscription_50_details": ["ğŸ’° Ù…Ø¨Ù„Øº 110 Ù‡Ø²Ø§Ø± ØªÙˆÙ…Ø§Ù† Ø±Ø§ ÙˆØ§Ø±ÛŒØ² Ú©Ù†ÛŒØ¯ Ø¨Ù‡ Ú©Ø§Ø±Øª:\n\n"
                                "5859831191786085\nØ´Ú©ÙˆÙÙ‡ Ø±Ø¶Ø§ÛŒÛŒ - Ø¨Ø§Ù†Ú© ØªØ¬Ø§Ø±Øª\n\n"
                                "ğŸ”µ - Ø§Ø±Ø³Ø§Ù„ Ø§Ø³Ú©Ø±ÛŒÙ† Ø´Ø§Øª Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª.\n"
                                "ğŸŸ¢ - Ù…Ù‡Ù„Øª ØªØ³Øª Ùˆ Ù¾Ø±Ø¯Ø§Ø®Øª 48 Ø³Ø§Ø¹Øª Ø§Ø³Øª.\n"
                                "ğŸŸ¡ - Ø¯Ø± ØµÙˆØ±Øª Ø¹Ø¯Ù… Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ø´ØªØ±Ø§Ú© Ø´Ù…Ø§ Ù„ØºÙˆ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.",
                                "9ï¸âƒ£ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ø±Ø­Ù„Ù‡ Ù‚Ø¨Ù„ÛŒ Ø¹Ø¯Ø¯  9  Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.\n"
                                "0ï¸âƒ£ Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯ Ø¹Ø¯Ø¯  0  Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯."],

    "subscription_30_details": ["ğŸ’° Ù…Ø¨Ù„Øº 90 Ù‡Ø²Ø§Ø± ØªÙˆÙ…Ø§Ù† Ø±Ø§ ÙˆØ§Ø±ÛŒØ² Ú©Ù†ÛŒØ¯ Ø¨Ù‡ Ú©Ø§Ø±Øª:\n\n"
                                "5859831191786085\nØ´Ú©ÙˆÙÙ‡ Ø±Ø¶Ø§ÛŒÛŒ - Ø¨Ø§Ù†Ú© ØªØ¬Ø§Ø±Øª\n\n"
                                "ğŸ”µ - Ø§Ø±Ø³Ø§Ù„ Ø§Ø³Ú©Ø±ÛŒÙ† Ø´Ø§Øª Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª.\n"
                                "ğŸŸ¢ - Ù…Ù‡Ù„Øª ØªØ³Øª Ùˆ Ù¾Ø±Ø¯Ø§Ø®Øª 48 Ø³Ø§Ø¹Øª Ø§Ø³Øª.\n"
                                "ğŸŸ¡ - Ø¯Ø± ØµÙˆØ±Øª Ø¹Ø¯Ù… Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ø´ØªØ±Ø§Ú© Ø´Ù…Ø§ Ù„ØºÙˆ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.",
                                "9ï¸âƒ£ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ø±Ø­Ù„Ù‡ Ù‚Ø¨Ù„ÛŒ Ø¹Ø¯Ø¯  9  Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.\n"
                                "0ï¸âƒ£ Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯ Ø¹Ø¯Ø¯  0  Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯."],
}

# Ù„ÛŒØ³Øª Ø¢ÛŒ Ø¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯Ù‡
blocked_ids = [7777, 88888]
# ØªØ§Ø¨Ø¹ ØªØ¨Ø¯ÛŒÙ„ Ø§Ø¹Ø¯Ø§Ø¯ ÙØ§Ø±Ø³ÛŒ Ø¨Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ
def persian_to_english_number(text):
    persian_numbers = 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'
    english_numbers = '0123456789'
    translation_table = str.maketrans(persian_numbers, english_numbers)
    return text.translate(translation_table)

async def send_messages(event, messages):
    """Ø§Ø±Ø³Ø§Ù„ Ù„ÛŒØ³ØªÛŒ Ø§Ø² Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±"""
    if isinstance(messages, list):
        for msg in messages:
            await event.respond(msg)
    else:
        await event.respond(messages)

@client.on(events.NewMessage(incoming=True))
async def handler(event):
    if not event.is_private:  # Ø´Ø±Ø· Ø¨Ø±Ø§ÛŒ Ú†Øª Ø®ØµÙˆØµÛŒ
        return
    if event.sender_id in blocked_ids:  # Ø´Ø±Ø· Ø¨Ø±Ø§ÛŒ Ù…Ø³Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† Ø¢ÛŒ Ø¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ø´Ø®Øµ Ø´Ø¯Ù‡
        return
    if await event.get_sender() and (await event.get_sender()).bot:  # Ø´Ø±Ø· Ø¨Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª Ø¨ÙˆØ¯Ù†
        return
    user_id = event.sender_id
    user_state.setdefault(user_id, "register")
    current_state = user_state[user_id]
    text = persian_to_english_number(event.raw_text.strip())

    logger.info(f"Received message from {user_id}: {text}")

    if any(keyword in text for keyword in ["Ø³Ù„Ø§Ù…", "Ø¯Ø±ÙˆØ¯", "salam", "Salam", "hi", "Hi"]):
        user = session.query(UserState).filter_by(user_id=user_id).first()
        if user:
            await send_messages(event, MESSAGES["welcome_user"].format(username=user.state))
            await send_messages(event, MESSAGES["main_menu"])
            user_state[user_id] = "main_menu"
            return
        else:
            await send_messages(event, MESSAGES["greeting"])
            await send_messages(event, MESSAGES["name_request"])
            user_state[user_id] = "awaiting_name"
            return

    if current_state == "awaiting_name":
        user_state[user_id] = "confirm_name"
        user_state[f"{user_id}_name"] = text
        await send_messages(event, MESSAGES["confirm_username"].format(text=text))
        return

    if current_state == "confirm_name":
        if text == "1":
            username = user_state.pop(f"{user_id}_name")
            user = session.query(UserState).filter_by(user_id=user_id).first()
            if user:
                user.state = username
            else:
                user = UserState(user_id=user_id, state=username)
                session.add(user)
            session.commit()
            user_state[user_id] = "main_menu"
            await send_messages(event, MESSAGES["welcome_user"].format(username=username))
            await send_messages(event, MESSAGES["main_menu"])
        elif text == "2":
            user_state[user_id] = "awaiting_name"
            await send_messages(event, MESSAGES["new_username_prompt"])
        return

    if current_state == "main_menu":
        if text == "1":
            user_state[user_id] = "awaiting_renew_subscription"
            await send_messages(event, MESSAGES["renew_subscription_prompt"])
        elif text == "2":
            user_state[user_id] = "awaiting_new_subscription"
            await send_messages(event, MESSAGES["new_subscription"])
        elif text == "3":
            user_state[user_id] = "awaiting_subscription_info"
            await send_messages(event, MESSAGES["subscription_info_prompt"])
        elif text == "4":
            user_state[user_id] = "awaiting_name"
            await send_messages(event, MESSAGES["new_username_prompt"])
        return

    if current_state == "awaiting_renew_subscription":
        if text == "9":
            user_state[user_id] = "main_menu"
            await send_messages(event, MESSAGES["main_menu"])
        elif text == "0":
            user_state[user_id] = "main_menu"
            await send_messages(event, MESSAGES["main_menu"])
        else:
            await send_messages(event, MESSAGES["renew_subscription_confirmation"].format(username=text))
            await send_messages(event, MESSAGES["renew_subscription_details"])
            user_state[user_id] = "renew_subscription"
        return

    if current_state == "renew_subscription":
        if text == "9":
            user_state[user_id] = "awaiting_renew_subscription"
            await send_messages(event, MESSAGES["renew_subscription_prompt"])
        elif text == "0":
            user_state[user_id] = "main_menu"
            await send_messages(event, MESSAGES["main_menu"])
        return

    if current_state == "awaiting_new_subscription":
        if text == "50" or text == "30":
            user_state[user_id] = "awaiting_new_subscription_username"
            await send_messages(event, MESSAGES["new_subscription_prompt"])
            user_state[f"{user_id}_subscription_type"] = text
        elif text == "9":
            user_state[user_id] = "main_menu"
            await send_messages(event, MESSAGES["main_menu"])
        elif text == "0":
            user_state[user_id] = "main_menu"
            await send_messages(event, MESSAGES["main_menu"])
        return

    if current_state == "awaiting_new_subscription_username":
        subscription_type = user_state.pop(f"{user_id}_subscription_type")
        if subscription_type == "50":
            await send_messages(event, MESSAGES["subscription_50_prompt"].format(username=text, volume=MESSAGES["50G"]))
            await send_messages(event, MESSAGES["subscription_50_details"])
        elif subscription_type == "30":
            await send_messages(event, MESSAGES["subscription_30_prompt"].format(username=text, volume=MESSAGES["30G"]))
            await send_messages(event, MESSAGES["subscription_30_details"])
        user_state[user_id] = "new_subscription"
        return

    if current_state == "new_subscription":
        if text == "9":
            user_state[user_id] = "awaiting_new_subscription"
            await send_messages(event, MESSAGES["new_subscription"])
        elif text == "0":
            user_state[user_id] = "main_menu"
            await send_messages(event, MESSAGES["main_menu"])
        return

    if current_state == "awaiting_subscription_info":
        if text == "9":
            user_state[user_id] = "main_menu"
            await send_messages(event, MESSAGES["main_menu"])
        elif text == "0":
            user_state[user_id] = "main_menu"
            await send_messages(event, MESSAGES["main_menu"])
        else:
            await send_messages(event, MESSAGES["subscription_info_confirmation"].format(username=text))
            await send_messages(event, MESSAGES["subscription_info_options"])
            user_state[user_id] = "subscription_info"
        return

    if current_state == "subscription_info":
        if text == "9":
            user_state[user_id] = "awaiting_subscription_info"
            await send_messages(event, MESSAGES["subscription_info_prompt"])
        elif text == "0":
            user_state[user_id] = "main_menu"
            await send_messages(event, MESSAGES["main_menu"])
        return

    logger.info(f"Sent messages to {user_id}")

client.start()
if client.is_connected():
    logger.info("Connected to Telegram.")
else:
    logger.error("Failed to connect to Telegram.")

client.run_until_disconnected()
